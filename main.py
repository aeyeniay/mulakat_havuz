"""
M√úLAKAT SORU HAVUZU - ANA CLI INTERFACE
=======================================

Komut satƒ±rƒ± aray√ºz√º ile soru √ºretimi ve Word export sistemi.
"""

import click
import logging
import sys
from pathlib import Path
from typing import Dict, Any

# Logging konfig√ºrasyonu
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler('mulakat_soru_havuzu.log')
    ]
)

logger = logging.getLogger(__name__)

# Import'lar
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from generators.single_generator import SingleGenerator
    from generators.batch_generator import BatchGenerator
    from exporters.word_exporter import WordExporter
    from config.roles_config import get_available_roles, get_role_config
    from config.question_categories import get_active_question_categories
    from core.difficulty_manager import DifficultyManager
    from utils.file_helpers import FileHelper
except ImportError as e:
    logger.error(f"Module import hatasƒ±: {e}")
    logger.error("L√ºtfen t√ºm baƒüƒ±mlƒ±lƒ±klarƒ±n y√ºkl√º olduƒüundan emin olun.")
    sys.exit(1)

@click.group()
@click.version_option(version='1.0.0', prog_name='M√ºlakat Soru Havuzu')
def cli():
    """
    M√ºlakat Soru Havuzu - AI destekli soru √ºretim sistemi
    
    Her rol i√ßin √∂zelle≈ütirilmi≈ü, zorluk seviyesine g√∂re m√ºlakat sorularƒ± √ºretir
    ve profesyonel Word belgeleri olu≈üturur.
    """
    pass

@cli.command()
@click.option('--role', '-r', required=True, help='Rol kodu (√∂rn: yazilim_gelistirici)')
@click.option('--difficulty', '-d', type=int, required=True, help='Zorluk seviyesi (2x, 3x, 4x)')
@click.option('--count', '-c', type=int, default=20, help='Toplam soru sayƒ±sƒ± (varsayƒ±lan: 20)')
@click.option('--categories', help='Belirli kategoriler (virg√ºlle ayrƒ±lmƒ±≈ü)')
@click.option('--job-file', help='ƒ∞lan metin dosyasƒ± yolu')
@click.option('--output-dir', default='data/word_exports', help='√áƒ±ktƒ± dizini')
@click.option('--no-word', is_flag=True, help='Word belgesi olu≈üturma')
@click.option('--preview', is_flag=True, help='Sadece √∂nizleme g√∂ster')
def generate(role, difficulty, count, categories, job_file, output_dir, no_word, preview):
    """
    Tek rol i√ßin belirli zorluk seviyesinde sorular √ºret.
    
    √ñrnek kullanƒ±m:
    python main.py generate --role yazilim_gelistirici --difficulty 4 --count 25
    """
    try:
        logger.info(f"Soru √ºretimi ba≈ülatƒ±lƒ±yor: {role} - {difficulty}x - {count} soru")
        
        # Single generator ba≈ülat
        generator = SingleGenerator()
        
        # Kategori daƒüƒ±lƒ±mƒ±nƒ± belirle
        if categories:
            # Belirli kategoriler
            category_list = [cat.strip() for cat in categories.split(',')]
            questions_per_category = count // len(category_list)
            question_counts = {cat: questions_per_category for cat in category_list}
            
            # Kalan sorularƒ± ilk kategoriye ekle
            remaining = count % len(category_list)
            if remaining > 0 and category_list:
                question_counts[category_list[0]] += remaining
        else:
            # Dengeli daƒüƒ±lƒ±m
            result = generator.generate_balanced_questions(
                role_code=role,
                salary_coefficient=difficulty,
                total_question_count=count
            )
            
            if preview:
                preview_result = generator.preview_generation_plan(role, difficulty, 
                    {cat: count//3 for cat in ['professional_experience', 'theoretical_knowledge', 'practical_application']})
                _print_preview(preview_result)
                return
            
            if not result.get("success", False):
                click.echo(f"‚ùå Hata: {result.get('error', 'Bilinmeyen hata')}", err=True)
                return
            
            # Word belgesini olu≈ütur
            if not no_word:
                _export_to_word(result, job_file, output_dir)
            
            _print_generation_summary(result)
            return
        
        # √ñnizleme modunda
        if preview:
            preview_result = generator.preview_generation_plan(role, difficulty, question_counts)
            _print_preview(preview_result)
            return
        
        # ƒ∞lan metni
        job_description = None
        if job_file:
            job_description = FileHelper.load_job_description(job_file)
        
        # Sorularƒ± √ºret
        result = generator.generate_questions(
            role_code=role,
            salary_coefficient=difficulty,
            question_counts=question_counts,
            job_description=job_description
        )
        
        if not result.get("success", False):
            click.echo(f"‚ùå Hata: {result.get('error', 'Bilinmeyen hata')}", err=True)
            return
        
        # Word belgesini olu≈ütur
        if not no_word:
            _export_to_word(result, job_file, output_dir)
        
        _print_generation_summary(result)
        
    except Exception as e:
        logger.error(f"Generate komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Beklenmeyen hata: {e}", err=True)

@cli.command()
@click.option('--role', '-r', required=True, help='Rol kodu')
@click.option('--all-difficulties', is_flag=True, help='T√ºm zorluk seviyeleri i√ßin √ºret')
@click.option('--count-per-level', type=int, default=15, help='Her seviye i√ßin soru sayƒ±sƒ±')
@click.option('--output-dir', default='data/word_exports', help='√áƒ±ktƒ± dizini')
@click.option('--job-file', help='ƒ∞lan metin dosyasƒ± yolu')
def batch_generate(role, all_difficulties, count_per_level, output_dir, job_file):
    """
    Tek rol i√ßin t√ºm zorluk seviyelerinde toplu √ºretim.
    
    √ñrnek kullanƒ±m:
    python main.py batch-generate --role yazilim_gelistirici --all-difficulties --count-per-level 20
    """
    try:
        logger.info(f"Toplu √ºretim ba≈ülatƒ±lƒ±yor: {role}")
        
        # Batch generator ba≈ülat
        batch_generator = BatchGenerator()
        
        # Soru sayƒ±sƒ±nƒ± kategorilere daƒüƒ±t
        active_categories = get_active_question_categories()
        questions_per_category = count_per_level // len(active_categories)
        question_counts = {cat[0]: questions_per_category for cat in active_categories}
        
        # ƒ∞lan metni
        job_description = None
        if job_file:
            job_description = FileHelper.load_job_description(job_file)
        
        # Toplu √ºretim
        result = batch_generator.generate_for_single_role_all_difficulties(
            role_code=role,
            question_counts=question_counts,
            job_description=job_description
        )
        
        if not result.get("success", False):
            click.echo(f"‚ùå Hata: {result.get('error', 'Bilinmeyen hata')}", err=True)
            return
        
        # Word belgelerini olu≈ütur
        word_exporter = WordExporter()
        
        role_config = get_role_config(role)
        if not job_description:
            try:
                job_file_path = f"data/job_descriptions/{role_config['job_description_file']}"
                job_description = FileHelper.load_job_description(job_file_path)
            except:
                job_description = f"{role_config['name']} pozisyonu i√ßin m√ºlakat sorularƒ±"
        
        # Her zorluk seviyesi i√ßin Word belgesi olu≈ütur
        exported_files = []
        for single_result in result["results"]:
            if single_result.get("success", False):
                output_path = word_exporter.generate_filename(
                    single_result["role"],
                    single_result["salary_coefficient"],
                    output_dir
                )
                
                if word_exporter.export_questions(single_result, job_description, output_path):
                    exported_files.append(output_path)
        
        _print_batch_summary(result, exported_files)
        
    except Exception as e:
        logger.error(f"Batch generate komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Beklenmeyen hata: {e}", err=True)

@cli.command()
@click.option('--config-file', '-c', required=True, help='Konfig√ºrasyon dosyasƒ± yolu')
@click.option('--output-dir', default='data/word_exports', help='√áƒ±ktƒ± dizini')
def mass_generate(config_file, output_dir):
    """
    Konfig√ºrasyon dosyasƒ±ndan √ßoklu rol √ºretimi.
    
    √ñrnek kullanƒ±m:
    python main.py mass-generate --config-file batch_config.json
    """
    try:
        logger.info(f"Kitlesel √ºretim ba≈ülatƒ±lƒ±yor: {config_file}")
        
        batch_generator = BatchGenerator()
        
        # Konfig√ºrasyon dosyasƒ±ndan √ºret
        result = batch_generator.generate_from_config_file(config_file)
        
        if not result.get("success", False):
            click.echo(f"‚ùå Hata: {result.get('error', 'Bilinmeyen hata')}", err=True)
            return
        
        # Word belgelerini olu≈ütur
        _export_mass_results_to_word(result["results"], output_dir)
        
        click.echo("‚úÖ Kitlesel √ºretim tamamlandƒ±!")
        _print_mass_summary(result)
        
    except Exception as e:
        logger.error(f"Mass generate komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Beklenmeyen hata: {e}", err=True)

@cli.command()
def list_roles():
    """Mevcut rolleri listele."""
    try:
        # API key kontrol etmeden direkt config'ten rolleri al
        import sys
        import os
        sys.path.append(os.path.dirname(os.path.abspath(__file__)))
        from config.roles_config import get_available_roles
        
        roles = get_available_roles()
        
        click.echo("\nüìã MEVCUT ROLLER:")
        click.echo("=" * 50)
        
        for role_code, role_name in roles:
            role_config = get_role_config(role_code)
            multipliers = role_config["salary_multipliers"]
            
            click.echo(f"üîπ {role_name}")
            click.echo(f"   Kod: {role_code}")
            click.echo(f"   Zorluk Seviyeleri: {multipliers}")
            click.echo(f"   √ñzel ≈ûartlar: {role_config['description'][:60]}...")
            click.echo()
            
    except Exception as e:
        logger.error(f"List roles komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Hata: {e}", err=True)

@cli.command()
def list_categories():
    """Soru kategorilerini listele."""
    try:
        categories = get_active_question_categories()
        
        click.echo("\nüìÇ SORU KATEGORƒ∞LERƒ∞:")
        click.echo("=" * 50)
        
        for category_code, category_name in categories:
            click.echo(f"üî∏ {category_name} ({category_code})")
        
        click.echo()
        
    except Exception as e:
        logger.error(f"List categories komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Hata: {e}", err=True)

@cli.command()
def check_status():
    """Sistem durumunu kontrol et."""
    try:
        from core.question_generator import QuestionGenerator
        
        click.echo("üîç Sƒ∞STEM DURUM KONTROL√ú")
        click.echo("=" * 50)
        
        # OpenAI API durumu
        generator = QuestionGenerator()
        api_status = generator.check_api_status()
        
        if api_status["api_available"]:
            click.echo("‚úÖ OpenAI API: Baƒülantƒ± ba≈üarƒ±lƒ±")
            click.echo(f"   Model: {api_status['model']}")
        else:
            click.echo("‚ùå OpenAI API: Baƒülantƒ± ba≈üarƒ±sƒ±z")
            click.echo(f"   Hata: {api_status.get('error', 'Bilinmeyen hata')}")
        
        # Dizin kontrolleri
        required_dirs = [
            "data/job_descriptions",
            "data/generated_questions", 
            "data/word_exports"
        ]
        
        click.echo("\nüìÅ Dƒ∞Zƒ∞N KONTROLLERI:")
        for dir_path in required_dirs:
            if Path(dir_path).exists():
                click.echo(f"‚úÖ {dir_path}")
            else:
                click.echo(f"‚ùå {dir_path} (eksik)")
                Path(dir_path).mkdir(parents=True, exist_ok=True)
                click.echo(f"   üìÅ Dizin olu≈üturuldu: {dir_path}")
        
        # ƒ∞lan dosyalarƒ±
        job_files = FileHelper.list_job_description_files("data/job_descriptions")
        click.echo(f"\nüìÑ ƒ∞lan Dosyalarƒ±: {len(job_files)} adet")
        for job_file in job_files[:3]:  # ƒ∞lk 3'√ºn√º g√∂ster
            click.echo(f"   ‚Ä¢ {job_file['filename']}")
        
        if len(job_files) > 3:
            click.echo(f"   ... ve {len(job_files) - 3} adet daha")
        
        click.echo("\n‚úÖ Sistem durumu kontrol√º tamamlandƒ±!")
        
    except Exception as e:
        logger.error(f"Check status komutu hatasƒ±: {e}")
        click.echo(f"‚ùå Hata: {e}", err=True)

# Yardƒ±mcƒ± fonksiyonlar
def _export_to_word(result: Dict[str, Any], job_file: str, output_dir: str):
    """Tek sonucu Word belgesine export et"""
    try:
        word_exporter = WordExporter()
        
        # ƒ∞lan metnini al
        job_description = ""
        if job_file:
            job_description = FileHelper.load_job_description(job_file)
        else:
            role_code = result.get("role_code")
            if role_code:
                role_config = get_role_config(role_code)
                try:
                    job_file_path = f"data/job_descriptions/{role_config['job_description_file']}"
                    job_description = FileHelper.load_job_description(job_file_path)
                except:
                    job_description = f"{result['role']} pozisyonu i√ßin m√ºlakat sorularƒ±"
        
        # Dosya yolu olu≈ütur
        output_path = word_exporter.generate_filename(
            result["role"],
            result["salary_coefficient"],
            output_dir
        )
        
        # Export et
        if word_exporter.export_questions(result, job_description, output_path):
            click.echo(f"üìÑ Word belgesi olu≈üturuldu: {output_path}")
        else:
            click.echo("‚ùå Word belgesi olu≈üturulamadƒ±", err=True)
            
    except Exception as e:
        logger.error(f"Word export hatasƒ±: {e}")
        click.echo(f"‚ùå Word export hatasƒ±: {e}", err=True)

def _print_generation_summary(result: Dict[str, Any]):
    """√úretim √∂zetini yazdƒ±r"""
    click.echo("\n‚úÖ SORU √úRETƒ∞Mƒ∞ TAMAMLANDI!")
    click.echo("=" * 50)
    click.echo(f"Rol: {result['role']}")
    click.echo(f"Zorluk: {result['salary_coefficient']}x")
    click.echo(f"Toplam Soru: {result.get('total_questions', 0)}")
    
    questions = result.get("questions", {})
    for category, category_questions in questions.items():
        successful_count = len([q for q in category_questions if q.get("success", False)])
        click.echo(f"  ‚Ä¢ {category}: {successful_count} soru")
    
    if result.get("json_file"):
        click.echo(f"\nüíæ JSON kaydedildi: {result['json_file']}")

def _print_preview(preview_result: Dict[str, Any]):
    """√ñnizleme sonucunu yazdƒ±r"""
    if not preview_result.get("valid", False):
        click.echo(f"‚ùå Ge√ßersiz konfig√ºrasyon: {preview_result.get('error')}", err=True)
        return
    
    click.echo("\nüëÅÔ∏è  √úRETƒ∞M √ñNƒ∞ZLEMESƒ∞")
    click.echo("=" * 50)
    
    role = preview_result["role"]
    difficulty = preview_result["difficulty"]
    
    click.echo(f"Rol: {role['name']} ({role['code']})")
    click.echo(f"Zorluk: {difficulty['difficulty_label']['label']} - {difficulty['difficulty_label']['name']}")
    click.echo(f"Toplam Soru: {preview_result['total_questions']}")
    click.echo(f"Tahmini API √áaƒürƒ±sƒ±: {preview_result['estimated_api_calls']}")
    
    click.echo("\nKategoriler:")
    for category in preview_result["categories"]:
        click.echo(f"  ‚Ä¢ {category['name']}: {category['question_count']} soru")
    
    click.echo(f"\nR√ºbrik Daƒüƒ±lƒ±mƒ±:")
    for level, percentage in difficulty["distribution"].items():
        click.echo(f"  ‚Ä¢ {level}: %{percentage}")

def _print_batch_summary(result: Dict[str, Any], exported_files: list):
    """Batch √ºretim √∂zetini yazdƒ±r"""
    click.echo("\n‚úÖ TOPLU √úRETƒ∞M TAMAMLANDI!")
    click.echo("=" * 50)
    click.echo(f"Rol: {result['role']}")
    click.echo(f"Ba≈üarƒ±lƒ± Seviyeler: {result['successful_difficulties']}/{result['total_difficulties']}")
    
    summary = result.get("summary", {})
    click.echo(f"Toplam Soru: {summary.get('total_questions_generated', 0)}")
    
    click.echo("\nüìÑ Olu≈üturulan Word Belgeleri:")
    for file_path in exported_files:
        click.echo(f"  ‚Ä¢ {file_path}")

def _print_mass_summary(result: Dict[str, Any]):
    """Kitlesel √ºretim √∂zetini yazdƒ±r"""
    click.echo("\nüìä Kƒ∞TLESEL √úRETƒ∞M √ñZETƒ∞:")
    click.echo("=" * 50)
    
    summary = result.get("summary", {})
    click.echo(f"Ba≈üarƒ±lƒ± G√∂revler: {result['successful_tasks']}/{result['total_tasks']}")
    click.echo(f"Toplam Soru: {summary.get('total_questions_generated', 0)}")
    click.echo(f"ƒ∞≈ülenen Roller: {summary.get('unique_roles_processed', 0)}")

def _export_mass_results_to_word(results: list, output_dir: str):
    """Kitlesel sonu√ßlarƒ± Word'e export et"""
    word_exporter = WordExporter()
    
    for result in results:
        if not result.get("success", False):
            continue
            
        try:
            role_code = result.get("role_code")
            role_config = get_role_config(role_code)
            
            # ƒ∞lan metnini y√ºkle
            try:
                job_file_path = f"data/job_descriptions/{role_config['job_description_file']}"
                job_description = FileHelper.load_job_description(job_file_path)
            except:
                job_description = f"{result['role']} pozisyonu i√ßin m√ºlakat sorularƒ±"
            
            # Export et
            output_path = word_exporter.generate_filename(
                result["role"],
                result["salary_coefficient"],
                output_dir
            )
            
            word_exporter.export_questions(result, job_description, output_path)
            
        except Exception as e:
            logger.error(f"Mass export hatasƒ± ({result.get('role', 'unknown')}): {e}")

if __name__ == '__main__':
    cli()